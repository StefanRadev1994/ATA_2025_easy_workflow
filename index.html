<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ATA 2025 Thyroid Cancer Clinical Decision Support</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: { 50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1', 500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43' },
            clinical: { 50: '#effcf6', 100: '#c6f7e2', 200: '#8eedc7', 300: '#65d6ad', 400: '#3ebd93', 500: '#27ab83', 600: '#199473', 700: '#147d64', 800: '#0c6b58', 900: '#014d40' },
          }
        }
      }
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-primary: #f7f9fc;
      --bg-card: #ffffff;
      --border-light: #e2e8f0;
      --accent: #0c6b58;
      --accent-light: #effcf6;
      --text-primary: #1a2b3c;
      --text-secondary: #627d98;
    }
    body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); }
    h1, h2, h3, .heading { font-family: 'Fraunces', Georgia, serif; }

    .card-medical {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(16, 42, 67, 0.04), 0 6px 16px rgba(16, 42, 67, 0.03);
    }

    .risk-low { background: #effcf6; color: #014d40; border-color: #8eedc7; }
    .risk-low-int { background: #fffbea; color: #5c4813; border-color: #f0d76e; }
    .risk-int-high { background: #fff3e0; color: #7c4a0d; border-color: #f5a623; }
    .risk-high { background: #fde8e8; color: #7c1d1d; border-color: #e53e3e; }

    .resp-excellent { background: #effcf6; color: #014d40; }
    .resp-indeterminate { background: #eef2ff; color: #3730a3; }
    .resp-biochem { background: #fffbea; color: #5c4813; }
    .resp-structural { background: #fde8e8; color: #7c1d1d; }

    .evidence-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .evidence-panel.open {
      max-height: 4000px;
      opacity: 1;
    }

    .medical-bg {
      background-image: radial-gradient(circle at 1px 1px, rgba(16, 42, 67, 0.015) 1px, transparent 0);
      background-size: 24px 24px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      transition: all 0.2s ease;
    }
    .btn-primary:hover:not(:disabled) {
      background: #014d40;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(12, 107, 88, 0.25);
    }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-secondary {
      background: white;
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .btn-secondary:hover:not(:disabled) {
      border-color: #9fb3c8;
      color: var(--text-primary);
    }

    .option-card {
      border: 1.5px solid var(--border-light);
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .option-card:hover { border-color: #9fb3c8; background: #f7f9fc; }
    .option-card.selected { border-color: var(--accent); background: var(--accent-light); }

    .input-field {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border-light);
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.15s ease;
      background: white;
    }
    .input-field:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(12, 107, 88, 0.08); }

    select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23627d98' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

    .section-line { height: 1px; background: linear-gradient(to right, transparent, var(--border-light), transparent); }

    .section-appear {
      animation: sectionIn 0.35s ease-out;
    }
    @keyframes sectionIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen medical-bg">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useCallback, useEffect, useRef } = React;

    /* ===================================================================
       CONSTANTS
       =================================================================== */
    const HISTOLOGY_OPTIONS = [
      "Papillary Thyroid Cancer (PTC)",
      "Follicular Thyroid Cancer (FTC)",
      "Oncocytic Thyroid Cancer (OTC)",
      "High-Grade Non-Anaplastic Thyroid Cancer (HGNATC)",
      "NIFTP",
      "Medullary Thyroid Cancer (MTC)"
    ];

    const T_STAGES = [
      { value: "1a", label: "T1a — intrathyroidal, \u22641 cm" },
      { value: "1b", label: "T1b — intrathyroidal, 1–2 cm" },
      { value: "2",  label: "T2 — intrathyroidal, 2–4 cm" },
      { value: "3a", label: "T3a — intrathyroidal, >4 cm" },
      { value: "3b", label: "T3b — gross extrathyroidal extension (strap muscles)" },
      { value: "4a", label: "T4a — moderately advanced (subcutaneous, larynx, trachea, esophagus, RLN)" },
      { value: "4b", label: "T4b — very advanced (prevertebral fascia, carotid, mediastinal vessels)" }
    ];

    const N_STAGES = [
      { value: "0",  label: "N0 — no regional lymph node metastasis" },
      { value: "1a", label: "N1a — level VI/VII (pretracheal, paratracheal, prelaryngeal)" },
      { value: "1b", label: "N1b — unilateral/bilateral/contralateral cervical or retropharyngeal" }
    ];

    const M_STAGES = [
      { value: "0", label: "M0 — no distant metastasis" },
      { value: "1", label: "M1 — distant metastasis" }
    ];

    const AS_CRITERIA = [
      { key: "presumedPTCmicro", label: "Presumed PTC \u22641 cm on cytology (cT1aN0M0)" },
      { key: "noClinicalNodes",  label: "No clinical or sonographic evidence of lymph node metastasis" },
      { key: "noETEorInvasion",  label: "No extrathyroidal extension or local invasion on imaging" },
      { key: "notNearCritical",  label: "Not abutting trachea or recurrent laryngeal nerve" }
    ];

    /* ===================================================================
       CLINICAL LOGIC
       =================================================================== */
    function pickRisk({ histology, tStage, nStage, mStage, activeSurveillance }) {
      if (activeSurveillance === "Yes") return "Low";
      var h = histology || "";
      if (h.includes("(MTC)") || h.includes("High-Grade")) return "High";
      if (mStage === "1") return "High";
      if (tStage === "4a" || tStage === "4b") return "High";
      if (nStage === "1b") return "High";
      if (tStage === "3a" || tStage === "3b" || nStage === "1a") return "Intermediate-High";
      if (tStage === "2" || tStage === "1b") return "Low-Intermediate";
      return "Low";
    }

    function pickResponse({ activeSurveillance, suspiciousUS, structuralDisease, tgTrend, tgAbTrend }) {
      if (activeSurveillance === "Yes") return "Indeterminate";
      if (structuralDisease === "Yes" || suspiciousUS === "Yes") return "Structurally Incomplete";
      if (tgTrend === "Rising" || tgAbTrend === "Rising") return "Biochemically Incomplete";
      return "Excellent";
    }

    function getTSHDetails({ risk, response }) {
      if (response === "Structurally Incomplete") {
        return { category: "Below normal range", range: "0.1–0.5 mIU/L (or <0.1 mIU/L if high disease burden)", rationale: "ATA 2025: Structurally incomplete response warrants TSH suppression. Target <0.1 mIU/L for significant structural disease burden (bulky cervical lymphadenopathy, distant metastases), and 0.1–0.5 mIU/L for lower-volume structural disease. Balance oncologic benefit against suppression risks: atrial fibrillation (HR 1.6 in patients >65 yr), accelerated bone mineral density loss (especially postmenopausal women), and angina." };
      }
      if (response === "Biochemically Incomplete") {
        return { category: "Below normal range", range: "0.1–0.5 mIU/L", rationale: "ATA 2025: Biochemically incomplete response warrants mild TSH suppression to 0.1–0.5 mIU/L. Approximately 30% will develop structural disease over 5–10 years. Stronger suppression (<0.1 mIU/L) is not warranted absent structural disease. In patients >65 years or with cardiovascular comorbidities, accept TSH 0.3–0.5 mIU/L." };
      }
      if (risk === "High") {
        return { category: "Below normal range", range: "<0.1 mIU/L for initial 1–2 years, then 0.1–0.5 mIU/L if excellent response achieved", rationale: "ATA 2025: High-risk patients benefit from initial aggressive TSH suppression (<0.1 mIU/L) for 1–2 years. If dynamic risk restratification shows excellent response (suppressed Tg <0.2 ng/mL, negative imaging, negative TgAb), relax to 0.1–0.5 mIU/L. Typical levothyroxine dose for suppression: 2.0–2.5 mcg/kg/day." };
      }
      if (risk === "Intermediate-High") {
        return { category: "Below normal range", range: "0.1–0.5 mIU/L initially; consider relaxation to 0.5–2.0 mIU/L after sustained excellent response (2–5 years)", rationale: "ATA 2025: Intermediate-high risk patients require initial TSH suppression to 0.1–0.5 mIU/L. After sustained excellent response over 2–5 years, TSH target can be relaxed to 0.5–2.0 mIU/L. Typical levothyroxine dose: 1.8–2.2 mcg/kg/day initially." };
      }
      if (risk === "Low-Intermediate") {
        return { category: "Within normal range", range: "0.5–2.0 mIU/L", rationale: "ATA 2025: Low-intermediate risk with excellent response does not require TSH suppression. Target TSH 0.5–2.0 mIU/L. Typical levothyroxine replacement dose: 1.6–1.8 mcg/kg/day (post-total thyroidectomy) or 1.0–1.4 mcg/kg/day (post-lobectomy)." };
      }
      return { category: "Within normal range", range: "0.5–2.0 mIU/L", rationale: "ATA 2025: Low-risk patients with excellent response should maintain TSH 0.5–2.0 mIU/L. No benefit to TSH suppression. Post-lobectomy patients may not require levothyroxine if euthyroid. After 10–15 years of sustained excellent response, consider discharge per ATA 2025 complete remission framework." };
    }

    function shouldConsiderRepeatRAI({ receivedRAI, response, structuralDisease, suspiciousUS, tgTrend, tgAbTrend }) {
      if (receivedRAI !== "Yes") return false;
      return (response === "Structurally Incomplete" || response === "Biochemically Incomplete" || structuralDisease === "Yes" || suspiciousUS === "Yes" || tgTrend === "Rising" || tgAbTrend === "Rising");
    }

    function shouldConsiderInitialRAI({ receivedRAI, risk, surgeryType, histology }) {
      if (receivedRAI === "Yes" || surgeryType !== "Total Thyroidectomy") return false;
      if ((histology || "").includes("(MTC)")) return false;
      return (risk === "Intermediate-High" || risk === "High");
    }

    /* ===================================================================
       ATA 2025 RECOMMENDATION BUILDER
       =================================================================== */
    function buildMockRecommendation(payload) {
      var risk = pickRisk(payload);
      var response = pickResponse(payload);
      var tshDetails = getTSHDetails({ risk: risk, response: response });
      var repeatRAI = shouldConsiderRepeatRAI({ receivedRAI: payload.receivedRAI, response: response, structuralDisease: payload.structuralDisease, suspiciousUS: payload.suspiciousUS, tgTrend: payload.tgTrend, tgAbTrend: payload.tgAbTrend });
      var initialRAI = shouldConsiderInitialRAI({ receivedRAI: payload.receivedRAI, risk: risk, surgeryType: payload.surgeryType, histology: payload.histology });
      var h = payload.histology || "";
      var isMTC = h.includes("(MTC)");
      var isHGNATC = h.includes("High-Grade");
      var isTT = payload.surgeryType === "Total Thyroidectomy";
      var isLob = payload.surgeryType === "Lobectomy";

      var immediate = [];

      if (payload.activeSurveillance === "Yes") {
        immediate = [
          "Perform baseline neck ultrasound documenting nodule dimensions (3 axes), echogenicity, margins, vascularity, calcifications, and relationship to trachea/RLN. Repeat at 6 months, then every 6–12 months for the first 5 years.",
          "Measure baseline serum Tg and TgAb (optional per ATA 2025; may aid monitoring if FNA-confirmed PTC). Document assay manufacturer for longitudinal consistency.",
          "Counsel patient on intervention triggers per ATA 2025: growth >3 mm in largest dimension, development of extrathyroidal extension, appearance of suspicious cervical lymphadenopathy.",
          "Assess patient preference and psychological readiness for surveillance vs. surgery at each visit. Document shared decision-making.",
          "Schedule follow-up in 6 months with neck ultrasound. If stable at 5 years, extend interval to 12–24 months."
        ];
      } else if (isMTC) {
        immediate = [
          "MTC-specific protocol: measure serum calcitonin (Ctn) and CEA at 2–3 months post-operatively as new baseline. Calcitonin doubling time <6 months indicates aggressive disease; 6–24 months intermediate; >24 months indolent.",
          "Confirm RET mutation status: germline RET testing for all MTC (rule out MEN2A/MEN2B). If germline RET-positive, screen for phaeochromocytoma (plasma metanephrines) and primary hyperparathyroidism (calcium, PTH). Somatic RET testing on tumour tissue for targeted therapy.",
          "RAI is NOT indicated for MTC — C-cells do not concentrate iodine. If structural disease persists, evaluate surgical options (central/lateral neck dissection). For unresectable local disease, consider EBRT (50–60 Gy in 25–30 fractions).",
          "If calcitonin >150 pg/mL post-operatively or CEA rising: obtain cross-sectional imaging (CT neck/chest, liver MRI, bone scan or FDG PET/CT). If calcitonin <150 pg/mL and CEA stable, serial calcitonin/CEA every 3–6 months.",
          "For progressive/unresectable MTC: vandetanib (300 mg/day) or cabozantinib (140 mg/day). For RET-mutated: selpercatinib (120–160 mg BID) or pralsetinib (400 mg/day) with superior response rates. Present to multidisciplinary tumor board."
        ];
      } else if (response === "Excellent") {
        if (risk === "Low") {
          immediate = [
            "Neck ultrasound at 12 months post-operatively (thyroid bed + central/lateral cervical compartments). If negative, repeat annually for 3 years, then every 2–3 years.",
            "Serum Tg (suppressed) and TgAb at 6–12 months. Target: suppressed Tg <0.2 ng/mL, stimulated Tg <1 ng/mL. Use same assay platform for all serial measurements.",
            "Levothyroxine to TSH 0.5–2.0 mIU/L. " + (isLob ? "Post-lobectomy: supplementation may not be needed if remaining lobe maintains euthyroidism (TSH <4.5 mIU/L)." : "Post-thyroidectomy: typical dose 1.6–1.8 mcg/kg/day; check TSH every 6–8 weeks until stable."),
            "RAI is NOT recommended for ATA low-risk with excellent response. " + (isLob ? "Completion thyroidectomy not routinely recommended." : "No further surgical intervention required."),
            "Document ATA risk (Low) and response (Excellent). Consider extended follow-up intervals after 3–5 years. Discharge from oncologic follow-up may be considered after 10–15 years of sustained excellent response."
          ];
        } else if (risk === "Low-Intermediate") {
          immediate = [
            "Neck ultrasound at 6–12 months with detailed evaluation of thyroid bed, central (level VI), and bilateral lateral compartments (levels II–V). Repeat annually for 5 years.",
            "Serum Tg and TgAb every 6 months for first 2 years, then annually. Target: suppressed Tg <0.2 ng/mL. Consider stimulated Tg at 12–24 months if Tg detectable but low.",
            "Levothyroxine to TSH 0.5–2.0 mIU/L (no suppression needed for this risk with excellent response). Check TSH every 6–8 weeks until stable, then every 6 months.",
            "RAI remnant ablation (30 mCi / 1.1 GBq) may be considered to facilitate Tg monitoring if post-thyroidectomy Tg >0.2 ng/mL, but is not mandatory per ATA 2025.",
            "If sustained excellent response for 3–5 years, transition to annual follow-up with Tg and intermittent ultrasound."
          ];
        } else if (risk === "Intermediate-High") {
          immediate = [
            "Neck ultrasound at 6 months post-treatment with compartment mapping (central VI, lateral II–V bilaterally). Repeat every 6–12 months for 5 years.",
            "Serum Tg and TgAb every 6 months. Target: suppressed Tg <0.2 ng/mL. Stimulated Tg >2 ng/mL warrants further imaging (diagnostic I-131 scan or cross-sectional imaging).",
            "Levothyroxine for TSH 0.1–0.5 mIU/L initially; reassess for relaxation to 0.5–2.0 mIU/L after 2–5 years of sustained excellent response.",
            (payload.receivedRAI === "Yes" ? "RAI already administered. No repeat RAI needed with current excellent response." : "Consider RAI adjuvant therapy (100–150 mCi / 3.7–5.5 GBq) if not already administered. Preparation: low-iodine diet 1–2 weeks, rhTSH or thyroid hormone withdrawal (TSH >30 mIU/L)."),
            "Excellent response reduces structural recurrence to 5–10% (vs 15–40% at initial staging). Continue close surveillance for at least 5 years before de-escalation."
          ];
        } else {
          immediate = [
            "Neck ultrasound every 6 months for first 3 years, then annually. Consider CT neck/chest at 12 months if initial N1b or bulky disease.",
            "Serum Tg and TgAb every 3–6 months. Stimulated Tg (rhTSH) at 9–12 months; stimulated Tg <1 ng/mL confirms excellent response. If TgAb-positive, trend as surrogate marker.",
            "Levothyroxine for TSH <0.1 mIU/L for initial 1–2 years. After sustained excellent response, relax to 0.1–0.5 mIU/L. DEXA at baseline and every 2 years; cardiac rhythm assessment annually for patients >60 yr.",
            (payload.receivedRAI === "Yes" ? "RAI already administered. No repeat needed with excellent response. If future biochemical recurrence, re-evaluate RAI candidacy." : "Administer RAI (150–200 mCi / 5.5–7.4 GBq). Preparation: low-iodine diet, TSH >30 mIU/L. Post-therapy WBS at 5–7 days."),
            "Lifelong follow-up recommended for initially high-risk patients. Excellent response drops structural recurrence to 5–10%."
          ];
        }
      } else if (response === "Biochemically Incomplete") {
        var marker = [payload.tgTrend === "Rising" ? "Rising Tg" : "", payload.tgAbTrend === "Rising" ? "Rising TgAb" : ""].filter(function(x) { return x; }).join(" and ") || "Abnormal biochemical markers";
        immediate = [
          marker + " identified. Confirm trend with repeat in 3 months (same assay/lab). Rule out assay interference (heterophilic antibodies, biotin). If Tg >10 ng/mL or doubling time <12 months, proceed to cross-sectional imaging (CT neck/chest or FDG PET/CT).",
          "Neck ultrasound with focused evaluation for structural correlate: thyroid bed, all cervical compartments. For suspicious nodes >8 mm shortest axis, FNA with Tg washout (positive if >1 ng/mL).",
          "Levothyroxine to TSH 0.1–0.5 mIU/L per ATA 2025. Avoid over-suppression (<0.1 mIU/L) in absence of structural disease, especially patients >65 years.",
          (repeatRAI ? "Prior RAI administered. Consider repeat RAI (100–150 mCi) if prior post-therapy scan showed RAI-avid disease. Obtain diagnostic I-131 WBS (2–5 mCi) first. Cumulative lifetime <600 mCi." : (initialRAI ? "RAI therapy (100–150 mCi / 3.7–5.5 GBq) recommended per ATA 2025. Preparation: low-iodine diet, TSH >30 mIU/L." : "RAI not indicated for current risk/response profile. Focus on serial Tg/TgAb monitoring and imaging.")),
          "If Tg continues rising without structural correlate: consider FDG PET/CT (best when TSH-stimulated) and present to multidisciplinary tumor board for empiric RAI, surgical exploration, or observation."
        ];
      } else if (response === "Structurally Incomplete") {
        immediate = [
          "Confirm structural disease: targeted high-resolution ultrasound. For cervical lymph nodes, FNA with cytology AND Tg washout (positive if >1 ng/mL). Document dimensions in 3 axes and proximity to vital structures.",
          "Obtain cross-sectional imaging for full staging: contrast-enhanced CT neck/chest (avoid iodinated contrast if RAI planned within 8 weeks). If distant metastases suspected (Tg >10 ng/mL, symptoms), add FDG PET/CT.",
          "Levothyroxine for TSH 0.1–0.5 mIU/L (or <0.1 mIU/L for significant structural disease burden). Monitor ECG if palpitations, DEXA every 2 years in postmenopausal women.",
          (repeatRAI ? "Prior RAI administered. Obtain diagnostic I-131 WBS (2–5 mCi) to assess avidity. If RAI-avid: repeat at 100–200 mCi (dosimetry-guided preferred). If non-avid: classify as RAI-refractory — consider surgery (locoregional) or systemic therapy (lenvatinib, sorafenib, or selective inhibitors if RET/NTRK/BRAF-mutated)." : (initialRAI ? "Administer RAI (150–200 mCi / 5.5–7.4 GBq). Post-therapy WBS at 5–7 days. If no uptake, classify as potentially RAI-refractory." : "RAI strongly recommended if not yet given. " + (isLob ? "Consider completion thyroidectomy before RAI." : "") + " Activity: 150–200 mCi for structural disease.")),
          "Present at multidisciplinary tumor board: surgical resection feasibility, RAI re-treatment, EBRT for unresectable local disease, systemic therapy for RAI-refractory progressive disease (lenvatinib 24 mg/day, sorafenib 800 mg/day; BRAF V600E: dabrafenib+trametinib; RET-fusion: selpercatinib; NTRK: larotrectinib/entrectinib)."
        ];
      } else {
        immediate = [
          "Indeterminate response: nonspecific findings per ATA 2025. Approximately 60–70% will reclassify as excellent with continued observation.",
          "Repeat Tg, TgAb, TSH in 6 months (same assay platform). Document low-level Tg precisely to detect trends.",
          "Neck ultrasound at 6–12 months. If nonspecific findings persist (sub-centimetre thyroid bed nodularity, borderline nodes), continue observation rather than FNA unless growth documented.",
          "Levothyroxine per underlying risk: " + (risk === "Low" || risk === "Low-Intermediate" ? "TSH 0.5–2.0 mIU/L (no suppression for low/low-intermediate with indeterminate response)." : "TSH 0.1–0.5 mIU/L (maintain suppression for intermediate-high/high risk until response clarified)."),
          "Reassess at 12–18 months. If Tg declines to <0.2 ng/mL and imaging normalises, reclassify as excellent and de-escalate. If Tg rises or structural findings emerge, reclassify and adjust."
        ];
      }

      var longTerm;
      if (payload.activeSurveillance === "Yes") {
        longTerm = "Per ATA 2025: neck ultrasound every 6–12 months for 5 years, then 12–24 months if stable. Intervention if growth >3 mm, ETE, or new lymphadenopathy. Long-term data show <1% progression to clinically significant disease at 10 years in appropriately selected patients.";
      } else if (isMTC) {
        longTerm = "MTC: calcitonin and CEA every 3–6 months for 2 years, then every 6–12 months. If calcitonin undetectable post-operatively, biochemical cure achieved (recurrence <5%). Calculate calcitonin doubling time at each visit — shortening doubling time warrants imaging escalation and systemic therapy consideration.";
      } else if (response === "Excellent" && (risk === "Low" || risk === "Low-Intermediate")) {
        longTerm = "Ultrasound annually for 3–5 years, then every 2–3 years. Tg annually; reduce frequency after 5 years of undetectable values. After 10–15 years of sustained excellent response, consider discharge from oncologic follow-up per ATA 2025 complete remission framework.";
      } else if (response === "Excellent") {
        longTerm = "Ultrasound and Tg/TgAb every 6–12 months for 5 years. After sustained excellent response, de-escalate TSH suppression and extend imaging intervals. Lifelong follow-up recommended for initially high-risk patients (5–10% late structural recurrence risk).";
      } else if (response === "Biochemically Incomplete") {
        longTerm = "Monitor Tg/TgAb every 3–6 months. Tg doubling time <12 months warrants cross-sectional imaging. ~30% develop structural disease; ~20% spontaneously resolve; ~50% remain stable. Maintain TSH 0.1–0.5 mIU/L. Annual ultrasound and cross-sectional imaging every 1–2 years.";
      } else if (response === "Structurally Incomplete") {
        longTerm = "Active management: surgery for resectable locoregional disease, repeat RAI for RAI-avid disease, EBRT for unresectable local disease. RAI-refractory progressive disease: lenvatinib or sorafenib first-line; BRAF V600E: dabrafenib+trametinib; RET-fusion: selpercatinib; NTRK: larotrectinib/entrectinib. Maintain TSH suppression, MDT review every 3–6 months.";
      } else {
        longTerm = "Continue serial monitoring every 6–12 months. Most indeterminate responses (60–70%) reclassify as excellent over 1–3 years. Adjust management once trajectory is clear.";
      }

      var evidence = [];
      evidence.push("RISK STRATIFICATION RATIONALE:");
      if (payload.activeSurveillance === "Yes") {
        evidence.push("Active surveillance for presumed cT1aN0M0 PTC (<1 cm). Supported by prospective data (Kuma Hospital, Ito et al.): <8% show growth >3 mm over 10 years, <3.5% develop node metastasis. Risk: Low (recurrence <1–2%).\n");
      } else {
        evidence.push("Histology: " + (payload.histology || "Not specified") + ". TNM: T" + (payload.tStage || "x") + "N" + (payload.nStage || "x") + "M" + (payload.mStage || "x") + ".");
        if (risk === "Low") evidence.push("ATA 2025 Low Risk: intrathyroidal DTC, no aggressive variant, no LVI, no ETE, N0M0. Structural recurrence: 1–3%. Disease-specific mortality: <1%.\n");
        else if (risk === "Low-Intermediate") evidence.push("ATA 2025 Low-Intermediate Risk: T1b–T2 intrathyroidal, and/or minor risk-elevating features. Structural recurrence: 5–15%. New category in ATA 2025 bridging Low and former Intermediate.\n");
        else if (risk === "Intermediate-High") evidence.push("ATA 2025 Intermediate-High Risk: T3 tumours, clinical N1a, extensive vascular invasion (>4 foci), or aggressive variants with limited extent. Structural recurrence: 15–40%. RAI adjuvant therapy generally recommended.\n");
        else evidence.push("ATA 2025 High Risk: T4, N1b, M1, HGNATC, MTC, or incomplete macroscopic resection. Structural recurrence: 40–70%. Aggressive multimodal therapy warranted.\n");
      }
      evidence.push("RESPONSE TO THERAPY RATIONALE:");
      if (response === "Excellent") evidence.push("Excellent response: negative imaging, suppressed Tg <0.2 ng/mL (stimulated <1 ng/mL), negative TgAb. Recurrence drops to 1–4% (low-risk) or 5–10% (high-risk).\n");
      else if (response === "Biochemically Incomplete") evidence.push("Biochemically incomplete: suppressed Tg >=1 ng/mL, stimulated Tg >=10 ng/mL, or rising Tg/TgAb without structural correlate. ~30% develop structural disease; Tg doubling time is key prognostic variable.\n");
      else if (response === "Structurally Incomplete") evidence.push("Structurally incomplete: persistent/new locoregional or distant disease on imaging. Management depends on RAI avidity, resectability, progression rate, FDG avidity, and molecular profile.\n");
      else evidence.push("Indeterminate: nonspecific findings. ~60–70% reclassify as excellent within 1–3 years.\n");
      evidence.push("TSH TARGET RATIONALE:");
      evidence.push(tshDetails.rationale);
      if (repeatRAI) { evidence.push("\nRAI CONSIDERATION: Prior RAI with incomplete response. Repeat if RAI-avid (diagnostic I-131 WBS). Dosimetry-guided preferred. Cumulative <600 mCi. If non-avid: RAI-refractory — consider systemic therapy."); }
      if (initialRAI) { evidence.push("\nRAI CONSIDERATION: " + risk + " risk, no prior RAI. Activity: 30–100 mCi remnant ablation (intermediate-high), 100–200 mCi treatment intent (high risk). Low-iodine diet, TSH >30 mIU/L. Post-therapy WBS at 5–7 days."); }
      if (isHGNATC && payload.activeSurveillance !== "Yes") { evidence.push("\nHGNATC NOTE: Distinct entity per ATA 2025. Elevated mitotic index (>=5/10 HPF) and/or necrosis. May have reduced RAI avidity. Consider molecular profiling (BRAF, RAS, RET, NTRK). More aggressive treatment warranted."); }

      return { risk: risk, response: response, tshDetails: tshDetails, immediate: immediate, longTerm: longTerm, evidence: evidence.join("\n") };
    }

    function buildPrompt(formData, computed) {
      var isAS = formData.managementType === "Active Surveillance";
      if (isAS) {
        return "You are an expert endocrinologist following ATA 2025 Guidelines for DTC.\n\nPatient: Age " + formData.patientAge + ", Active Surveillance (cT1aN0M0 PTC).\n\nRespond in STRICT JSON only (no markdown/backticks/preamble):\n{\"risk\":\"Low\",\"response\":\"N/A - Active Surveillance\",\"tshCategory\":\"Within normal range\",\"tshRange\":\"0.5-2.0 mIU/L\",\"tshRationale\":\"...\",\"immediate\":[5 specific items with doses/intervals/thresholds],\"longTerm\":\"2-3 sentences with ATA 2025 specifics\",\"evidence\":\"Detailed rationale with ATA 2025 references\"}\nNo emojis.";
      }
      return "You are an expert endocrinologist following ATA 2025 Guidelines for DTC.\n\nPatient: Age " + formData.patientAge + ", Op " + formData.yearOfOperation + ", " + formData.surgeryType + ", " + formData.histology + ", T" + formData.tnmStaging.t + "N" + formData.tnmStaging.n + "M" + formData.tnmStaging.m + ", Tg: " + (formData.labResults.tg || "N/A") + " ng/mL, TSH: " + (formData.labResults.tsh || "N/A") + " mIU/L, Prior RAI: " + formData.receivedRAI + ", Tg trend: " + formData.tgTrend + ", TgAb trend: " + formData.tgAbTrend + ", Structural disease: " + formData.structuralDisease + ", Suspicious US: " + formData.suspiciousUS + "\n\nRespond in STRICT JSON only:\n{\"risk\":\"Low|Low-Intermediate|Intermediate-High|High\",\"response\":\"Excellent|Biochemically Incomplete|Structurally Incomplete|Indeterminate\",\"tshCategory\":\"Within normal range|Below normal range\",\"tshRange\":\"specific mIU/L\",\"tshRationale\":\"...\",\"immediate\":[5 items with specific doses/mCi/intervals/Tg thresholds],\"longTerm\":\"2-3 sentences with ATA 2025 intervals and de-escalation criteria\",\"evidence\":\"Comprehensive rationale with ATA 2025 criteria and outcome data\"}\nNo emojis. Specific clinical details required.";
    }


    /* ===================================================================
       UI COMPONENTS
       =================================================================== */
    function Card({ children, className }) {
      return <div className={"card-medical p-5 md:p-6 " + (className || "")}>{children}</div>;
    }

    function SectionLabel({ num, title }) {
      return (
        <div className="flex items-center gap-3 mb-4">
          <div className="flex-shrink-0 w-6 h-6 rounded-md bg-navy-800 text-white flex items-center justify-center text-xs font-bold">{num}</div>
          <h2 className="heading text-base text-navy-900" style={{ fontWeight: 600 }}>{title}</h2>
        </div>
      );
    }

    function RadioGroup({ options, value, onChange, name, compact }) {
      return (
        <div className={compact ? "flex flex-wrap gap-2" : "space-y-1.5"}>
          {options.map(function(opt) {
            var val = typeof opt === "string" ? opt : opt.value;
            var label = typeof opt === "string" ? opt : opt.label;
            if (compact) {
              return (
                <button key={val} className={"px-4 py-2 rounded-lg text-sm font-medium border transition-all " + (value === val ? "border-clinical-700 bg-clinical-50 text-clinical-800" : "border-navy-200 bg-white text-navy-600 hover:border-navy-300")} onClick={function() { onChange(val); }}>{label}</button>
              );
            }
            return (
              <label key={val} className={"option-card flex items-center gap-3 " + (value === val ? "selected" : "")}>
                <input type="radio" name={name} className="w-4 h-4 accent-clinical-700" checked={value === val} onChange={function() { onChange(val); }} />
                <span className="text-sm font-medium text-navy-800">{label}</span>
              </label>
            );
          })}
        </div>
      );
    }

    function SelectField({ label, value, onChange, options, placeholder }) {
      return (
        <div>
          {label && <label className="block text-xs font-semibold text-navy-500 uppercase tracking-wide mb-1.5">{label}</label>}
          <select value={value} onChange={function(e) { onChange(e.target.value); }} className="input-field">
            <option value="">{placeholder || "Select..."}</option>
            {options.map(function(o) {
              var val = typeof o === "string" ? o : o.value;
              var lab = typeof o === "string" ? o : o.label;
              return <option key={val} value={val}>{lab}</option>;
            })}
          </select>
        </div>
      );
    }

    function NumericInput({ label, defaultValue, onUpdate, maxDigits, placeholder }) {
      return (
        <div>
          <label className="block text-xs font-semibold text-navy-500 uppercase tracking-wide mb-1.5">{label}</label>
          <input className="input-field" type="text" inputMode="numeric" autoComplete="off" defaultValue={defaultValue} onInput={function(e) { var v = e.currentTarget.value.replace(/[^0-9]/g, "").slice(0, maxDigits || 4); e.currentTarget.value = v; onUpdate(v); }} placeholder={placeholder} />
        </div>
      );
    }

    function TextInput({ label, defaultValue, onUpdate, placeholder }) {
      return (
        <div>
          <label className="block text-xs font-semibold text-navy-500 uppercase tracking-wide mb-1.5">{label}</label>
          <input className="input-field" type="text" autoComplete="off" defaultValue={defaultValue} onInput={function(e) { onUpdate(e.currentTarget.value); }} placeholder={placeholder} />
        </div>
      );
    }


    /* ===================================================================
       RECOMMENDATION DISPLAY
       =================================================================== */
    function RecommendationDisplay({ recData, loading }) {
      var evidenceState = useState(false);
      var showEvidence = evidenceState[0];
      var setShowEvidence = evidenceState[1];

      if (loading) {
        return (
          <Card className="mt-4">
            <div className="flex flex-col items-center justify-center py-10">
              <div className="w-10 h-10 rounded-full animate-spin mb-4" style={{ border: "3px solid #d9e2ec", borderTopColor: "#147d64" }}></div>
              <p className="text-navy-600 font-semibold text-sm">Generating recommendation...</p>
              <p className="text-xs text-navy-400 mt-1">Analyzing against ATA 2025 guidelines</p>
            </div>
          </Card>
        );
      }
      if (!recData) return null;

      var riskCls = { "Low": "risk-low", "Low-Intermediate": "risk-low-int", "Intermediate-High": "risk-int-high", "High": "risk-high" };
      var respCls = { "Excellent": "resp-excellent", "Indeterminate": "resp-indeterminate", "Biochemically Incomplete": "resp-biochem", "Structurally Incomplete": "resp-structural" };
      var tshRange = (recData.tshDetails && recData.tshDetails.range) || recData.tshRange || "—";

      return (
        <div className="mt-4 space-y-4 section-appear">
          <Card>
            <div className="flex items-center gap-3 mb-5">
              <div className="flex-shrink-0 w-7 h-7 rounded-lg bg-clinical-700 text-white flex items-center justify-center">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
              </div>
              <h2 className="heading text-lg text-navy-900" style={{ fontWeight: 600 }}>Clinical Recommendation</h2>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
              <div className={"p-3 rounded-lg border " + (riskCls[recData.risk] || "bg-navy-50")}>
                <p className="font-bold opacity-70" style={{ fontSize: "10px", textTransform: "uppercase", letterSpacing: "0.05em" }}>Risk Stratification</p>
                <p className="text-sm font-bold mt-0.5">{recData.risk}</p>
              </div>
              <div className={"p-3 rounded-lg " + (respCls[recData.response] || "bg-navy-50")}>
                <p className="font-bold opacity-70" style={{ fontSize: "10px", textTransform: "uppercase", letterSpacing: "0.05em" }}>Response to Therapy</p>
                <p className="text-sm font-bold mt-0.5">{recData.response}</p>
              </div>
              <div className="p-3 rounded-lg bg-amber-50 text-amber-900">
                <p className="font-bold opacity-70" style={{ fontSize: "10px", textTransform: "uppercase", letterSpacing: "0.05em" }}>TSH Target</p>
                <p className="text-xs font-bold mt-0.5">{tshRange}</p>
              </div>
            </div>

            <div className="mb-5" style={{ borderLeft: "3px solid #2b6cb0", paddingLeft: "16px" }}>
              <h3 className="text-xs font-bold text-navy-500 uppercase tracking-wider mb-3">Immediate Management (Next 1-6 Months)</h3>
              <div className="space-y-3">
                {recData.immediate.map(function(item, i) {
                  return (
                    <div key={i} className="flex gap-3 text-sm text-navy-700 leading-relaxed">
                      <span className="flex-shrink-0 w-5 h-5 rounded-full bg-navy-100 text-navy-600 flex items-center justify-center font-bold mt-0.5" style={{ fontSize: "10px" }}>{i + 1}</span>
                      <span>{item}</span>
                    </div>
                  );
                })}
              </div>
            </div>

            <div style={{ borderLeft: "3px solid #718096", paddingLeft: "16px" }}>
              <h3 className="text-xs font-bold text-navy-500 uppercase tracking-wider mb-3">Long-Term Strategy</h3>
              <p className="text-sm text-navy-700 leading-relaxed">{recData.longTerm}</p>
            </div>
          </Card>

          <div className="card-medical overflow-hidden">
            <button className="w-full flex items-center justify-between p-4 text-left hover:bg-navy-50 transition-colors" onClick={function() { setShowEvidence(!showEvidence); }}>
              <div className="flex items-center gap-3">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#627d98" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                <span className="text-sm font-semibold text-navy-700">Supporting Evidence & Rationale</span>
              </div>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#627d98" strokeWidth="2" style={{ transform: showEvidence ? "rotate(180deg)" : "rotate(0deg)", transition: "transform 0.3s ease" }}><polyline points="6 9 12 15 18 9" /></svg>
            </button>
            <div className={"evidence-panel " + (showEvidence ? "open" : "")}>
              <div className="px-4 pb-4">
                <div className="section-line mb-3" />
                <pre className="whitespace-pre-wrap text-sm text-navy-600 leading-relaxed" style={{ fontFamily: "'DM Sans', system-ui, sans-serif" }}>{typeof recData.evidence === "string" ? recData.evidence : "No additional evidence available."}</pre>
              </div>
            </div>
          </div>
        </div>
      );
    }


    /* ===================================================================
       MAIN APP — Single page, progressive reveal
       =================================================================== */
    function App() {
      var loadState = useState(false);
      var loading = loadState[0]; var setLoading = loadState[1];
      var recState = useState(null);
      var recData = recState[0]; var setRecData = recState[1];
      var fvState = useState(1);
      var formVersion = fvState[0]; var setFormVersion = fvState[1];

      var fdState = useState({
        patientAge: "", yearOfOperation: "", managementType: "", surgeryType: "",
        asEligibility: { presumedPTCmicro: "", noClinicalNodes: "", noETEorInvasion: "", notNearCritical: "" },
        histology: "", tnmStaging: { t: "", n: "", m: "" }, receivedRAI: "", tgTrend: "", tgAbTrend: "",
        structuralDisease: "", labResults: { tg: "", tsh: "" }, suspiciousUS: ""
      });
      var formData = fdState[0]; var setFormData = fdState[1];

      var isAS = formData.managementType === "Active Surveillance";
      var isSurgery = formData.managementType === "Surgery";

      var update = useCallback(function(field, value) {
        setFormData(function(prev) { var next = Object.assign({}, prev); next[field] = value; return next; });
      }, []);
      var updateNested = useCallback(function(path, value) {
        var parts = path.split(".");
        setFormData(function(prev) { var next = Object.assign({}, prev); next[parts[0]] = Object.assign({}, prev[parts[0]]); next[parts[0]][parts[1]] = value; return next; });
      }, []);

      /* Progressive visibility logic */
      var hasDemographics = formData.patientAge !== "";
      var hasManagement = !!formData.managementType;
      var hasSurgeryType = isSurgery ? !!formData.surgeryType : false;
      var asElig = formData.asEligibility;
      var hasASEligibility = isAS ? (asElig.presumedPTCmicro === "Yes" && asElig.noClinicalNodes === "Yes" && asElig.noETEorInvasion === "Yes" && asElig.notNearCritical === "Yes") : false;
      var managementComplete = isSurgery ? hasSurgeryType : (isAS ? hasASEligibility : false);

      var hasHistology = isAS ? true : !!formData.histology;
      var hasTNM = isAS ? true : (!!formData.tnmStaging.t && !!formData.tnmStaging.n && !!formData.tnmStaging.m);
      var hasResponse = isAS ? true : (!!formData.receivedRAI && !!formData.tgTrend && !!formData.tgAbTrend && !!formData.structuralDisease);
      var hasUS = isAS ? true : !!formData.suspiciousUS;

      var showSection2 = hasDemographics;
      var showSection3 = hasDemographics && managementComplete && !isAS;
      var showSection4 = showSection3 && hasHistology;
      var showSection5 = isAS ? (hasDemographics && managementComplete) : (showSection4 && hasTNM);
      var showSection6 = isAS ? false : (showSection5 && hasResponse);
      var showGenerate = isAS ? (hasDemographics && managementComplete) : (showSection6 && hasUS);

      var computed = useMemo(function() {
        var asFlag = isAS ? "Yes" : "No";
        return {
          computedRiskTier: pickRisk({ histology: formData.histology, tStage: formData.tnmStaging.t, nStage: formData.tnmStaging.n, mStage: formData.tnmStaging.m, activeSurveillance: asFlag }),
          computedResponse: pickResponse({ activeSurveillance: asFlag, suspiciousUS: formData.suspiciousUS, structuralDisease: formData.structuralDisease, tgTrend: formData.tgTrend, tgAbTrend: formData.tgAbTrend })
        };
      }, [formData, isAS]);

      var resetAll = useCallback(function() {
        setRecData(null);
        setFormVersion(function(v) { return v + 1; });
        setFormData({
          patientAge: "", yearOfOperation: "", managementType: "", surgeryType: "",
          asEligibility: { presumedPTCmicro: "", noClinicalNodes: "", noETEorInvasion: "", notNearCritical: "" },
          histology: "", tnmStaging: { t: "", n: "", m: "" }, receivedRAI: "", tgTrend: "", tgAbTrend: "",
          structuralDisease: "", labResults: { tg: "", tsh: "" }, suspiciousUS: ""
        });
      }, []);

      var generateRecommendation = useCallback(function() {
        setLoading(true);
        setRecData(null);

        function useMock() {
          var payload = { activeSurveillance: isAS ? "Yes" : "No", histology: formData.histology, tStage: formData.tnmStaging.t, nStage: formData.tnmStaging.n, mStage: formData.tnmStaging.m, suspiciousUS: formData.suspiciousUS, structuralDisease: formData.structuralDisease, tgTrend: formData.tgTrend, tgAbTrend: formData.tgAbTrend, receivedRAI: formData.receivedRAI, surgeryType: formData.surgeryType };
          setRecData(buildMockRecommendation(payload));
          setLoading(false);
        }

        var prompt = buildPrompt(formData, computed);
        fetch("https://api.anthropic.com/v1/messages", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 2000, messages: [{ role: "user", content: prompt }] })
        }).then(function(r) { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(function(data) {
          if (data.content && data.content[0]) {
            try {
              var text = data.content[0].text.replace(/```json|```/g, "").trim();
              var p = JSON.parse(text);
              setRecData({ risk: p.risk, response: p.response, tshDetails: { category: p.tshCategory, range: p.tshRange, rationale: p.tshRationale }, tshRange: p.tshRange, immediate: p.immediate || [], longTerm: p.longTerm || "", evidence: p.evidence || "" });
              setLoading(false);
              return;
            } catch (e) { console.warn("Parse failed:", e); }
          }
          useMock();
        }).catch(function() { useMock(); });
      }, [formData, computed, isAS]);

      /* Auto-scroll when generate button or recommendation appears */
      var recRef = useRef(null);
      useEffect(function() {
        if (recData && recRef.current) {
          recRef.current.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }, [recData]);

      return (
        <div className="min-h-screen py-8 px-4">
          <div className="max-w-2xl mx-auto">

            {/* Header */}
            <div className="mb-6">
              <div className="flex items-center gap-2 mb-1.5">
                <div className="w-2 h-2 rounded-full bg-clinical-600"></div>
                <span className="text-clinical-700" style={{ fontSize: "10px", fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.15em" }}>Clinical Decision Support</span>
              </div>
              <h1 className="heading text-2xl md:text-3xl text-navy-900 leading-tight" style={{ fontWeight: 700 }}>ATA 2025 Thyroid Cancer Management Assistant</h1>
              <p className="text-navy-400 text-sm mt-1">Evidence-based recommendations for differentiated thyroid cancer</p>
            </div>

            <div className="space-y-4">

              {/* 1. Demographics */}
              <Card key={"s1-" + formVersion}>
                <SectionLabel num={1} title="Patient Demographics" />
                <div className="grid grid-cols-2 gap-4">
                  <NumericInput label="Age (years)" defaultValue={formData.patientAge} onUpdate={function(v) { update("patientAge", v); }} maxDigits={3} placeholder="e.g., 52" />
                  <NumericInput label="Year of operation" defaultValue={formData.yearOfOperation} onUpdate={function(v) { update("yearOfOperation", v); }} maxDigits={4} placeholder="e.g., 2024" />
                </div>
              </Card>

              {/* 2. Management */}
              {showSection2 && (
                <Card className="section-appear" key={"s2-" + formVersion}>
                  <SectionLabel num={2} title="Management Approach" />
                  <RadioGroup options={["Surgery", "Active Surveillance"]} value={formData.managementType} onChange={function(v) { update("managementType", v); }} name="mgmt" compact={true} />

                  {isSurgery && (
                    <div className="mt-4 pt-4 border-t border-navy-100">
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Extent of surgery</p>
                      <RadioGroup options={["Total Thyroidectomy", "Lobectomy"]} value={formData.surgeryType} onChange={function(v) { update("surgeryType", v); }} name="surgType" compact={true} />
                    </div>
                  )}

                  {isAS && (
                    <div className="mt-4 pt-4 border-t border-navy-100">
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Confirm eligibility (all must be Yes)</p>
                      <div className="space-y-1.5">
                        {AS_CRITERIA.map(function(c) {
                          return (
                            <div key={c.key} className="flex items-center justify-between p-2.5 bg-navy-50 rounded-lg">
                              <span className="text-xs text-navy-700 flex-1 mr-2">{c.label}</span>
                              <div className="flex gap-1">
                                {["Yes", "No"].map(function(v) {
                                  return <button key={v} className={"px-2.5 py-0.5 rounded text-xs font-semibold transition-all " + (formData.asEligibility[c.key] === v ? (v === "Yes" ? "bg-clinical-700 text-white" : "bg-red-500 text-white") : "bg-white border border-navy-200 text-navy-500")} onClick={function() { updateNested("asEligibility." + c.key, v); }}>{v}</button>;
                                })}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </Card>
              )}

              {/* 3. Histology (surgery only) */}
              {showSection3 && (
                <Card className="section-appear" key={"s3-" + formVersion}>
                  <SectionLabel num={3} title="Histological Diagnosis" />
                  <RadioGroup options={HISTOLOGY_OPTIONS} value={formData.histology} onChange={function(v) { update("histology", v); }} name="histo" />
                </Card>
              )}

              {/* 4. TNM (surgery only) */}
              {showSection4 && (
                <Card className="section-appear" key={"s4-" + formVersion}>
                  <SectionLabel num={4} title="Pathological TNM Staging (AJCC 8th Ed)" />
                  <div className="space-y-3">
                    <SelectField label="T Stage" value={formData.tnmStaging.t} onChange={function(v) { updateNested("tnmStaging.t", v); }} options={T_STAGES} placeholder="Select T stage" />
                    <SelectField label="N Stage" value={formData.tnmStaging.n} onChange={function(v) { updateNested("tnmStaging.n", v); }} options={N_STAGES} placeholder="Select N stage" />
                    <SelectField label="M Stage" value={formData.tnmStaging.m} onChange={function(v) { updateNested("tnmStaging.m", v); }} options={M_STAGES} placeholder="Select M stage" />
                  </div>
                </Card>
              )}

              {/* 5. Response Assessment (surgery only) */}
              {showSection5 && !isAS && (
                <Card className="section-appear" key={"s5-" + formVersion}>
                  <SectionLabel num={5} title="Response Assessment" />
                  <div className="space-y-4">
                    <div>
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Previous RAI therapy?</p>
                      <RadioGroup options={["Yes", "No"]} value={formData.receivedRAI} onChange={function(v) { update("receivedRAI", v); }} name="rai" compact={true} />
                    </div>
                    <div className="section-line" />
                    <div>
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Thyroglobulin (Tg) trend</p>
                      <RadioGroup options={["Rising", "Stable", "Declining", "Undetectable"]} value={formData.tgTrend} onChange={function(v) { update("tgTrend", v); }} name="tg" compact={true} />
                    </div>
                    <div>
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">TgAb trend</p>
                      <RadioGroup options={["Rising", "Stable", "Declining", "Negative"]} value={formData.tgAbTrend} onChange={function(v) { update("tgAbTrend", v); }} name="tgab" compact={true} />
                    </div>
                    <div className="section-line" />
                    <div>
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Known structural disease?</p>
                      <RadioGroup options={["Yes", "No"]} value={formData.structuralDisease} onChange={function(v) { update("structuralDisease", v); }} name="struct" compact={true} />
                    </div>
                  </div>
                </Card>
              )}

              {/* 6. Ultrasound + Labs (surgery only) */}
              {showSection6 && (
                <Card className="section-appear" key={"s6-" + formVersion}>
                  <SectionLabel num={6} title="Current Imaging & Laboratory" />
                  <div className="space-y-4">
                    <div>
                      <p className="text-xs font-semibold text-navy-500 uppercase tracking-wide mb-2">Suspicious findings on latest neck ultrasound?</p>
                      <RadioGroup options={["Yes", "No"]} value={formData.suspiciousUS} onChange={function(v) { update("suspiciousUS", v); }} name="us" compact={true} />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <TextInput label="Latest Tg (ng/mL)" defaultValue={formData.labResults.tg} onUpdate={function(v) { updateNested("labResults.tg", v); }} placeholder="e.g., 0.2" />
                      <TextInput label="Latest TSH (mIU/L)" defaultValue={formData.labResults.tsh} onUpdate={function(v) { updateNested("labResults.tsh", v); }} placeholder="e.g., 1.5" />
                    </div>
                  </div>
                </Card>
              )}

              {/* Generate Button */}
              {showGenerate && !recData && (
                <div className="section-appear" ref={recRef}>
                  {/* Quick computed preview */}
                  <div className="flex flex-wrap gap-2 mb-3">
                    <span className={"inline-block px-3 py-1 rounded-full text-xs font-bold border " + ({ "Low": "risk-low", "Low-Intermediate": "risk-low-int", "Intermediate-High": "risk-int-high", "High": "risk-high" }[computed.computedRiskTier] || "")}>{computed.computedRiskTier} Risk</span>
                    {!isAS && <span className={"inline-block px-3 py-1 rounded-full text-xs font-bold " + ({ "Excellent": "resp-excellent", "Indeterminate": "resp-indeterminate", "Biochemically Incomplete": "resp-biochem", "Structurally Incomplete": "resp-structural" }[computed.computedResponse] || "")}>{computed.computedResponse} Response</span>}
                  </div>
                  <button className="btn-primary w-full py-3 rounded-lg text-sm font-semibold" disabled={loading} onClick={generateRecommendation}>
                    {loading ? "Generating..." : "Generate Recommendation"}
                  </button>
                </div>
              )}

              {/* Recommendation output */}
              <div ref={!showGenerate || recData ? recRef : undefined}>
                <RecommendationDisplay recData={recData} loading={loading} />
              </div>

              {/* New Patient */}
              {recData && (
                <div className="text-center pt-2">
                  <button className="btn-secondary px-5 py-2.5 rounded-lg text-sm font-semibold" onClick={resetAll}>New Patient Assessment</button>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="mt-10 pt-6 border-t border-navy-100 text-center">
              <p className="text-navy-400" style={{ fontSize: "11px" }}>Based on the 2025 American Thyroid Association Management Guidelines for Adult Patients with Differentiated Thyroid Cancer</p>
              <p className="text-navy-300 mt-1" style={{ fontSize: "10px" }}>For clinical decision support only. Always apply individual clinical judgment.</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
